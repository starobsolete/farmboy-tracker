<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Farm Boy Tracker</title>
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Farm Boy">
<meta name="theme-color" content="#2d6a4f">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #2d6a4f;
    --green-light: #52b788;
    --green-pale: #d8f3dc;
    --red: #c1121f;
    --red-light: #e85d5d;
    --red-pale: #ffe0e0;
    --cream: #faf7f2;
    --brown: #5c3d2e;
    --gold: #e9c46a;
    --text: #2b2b2b;
    --muted: #888;
    --border: #e8e0d5;
    --shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

  /* ‚îÄ‚îÄ PASSWORD SCREEN ‚îÄ‚îÄ */
  #lockScreen { position: fixed; inset: 0; background: var(--green); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; padding: 40px 30px; }
  #lockScreen.hidden { display: none; }
  .lock-leaf { font-size: 56px; margin-bottom: 12px; }
  .lock-title { font-family: 'Playfair Display', serif; color: white; font-size: 32px; font-weight: 900; margin-bottom: 4px; }
  .lock-sub { color: var(--green-light); font-size: 13px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; }
  .lock-label { color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; align-self: flex-start; width: 100%; max-width: 320px; }
  .lock-input { width: 100%; max-width: 320px; padding: 16px 18px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 14px; color: white; font-family: 'DM Sans', sans-serif; font-size: 18px; outline: none; text-align: center; letter-spacing: 3px; margin-bottom: 14px; transition: border-color 0.2s; }
  .lock-input::placeholder { color: rgba(255,255,255,0.4); letter-spacing: 1px; }
  .lock-input:focus { border-color: var(--gold); }
  .lock-btn { width: 100%; max-width: 320px; padding: 16px; background: var(--gold); color: var(--brown); border: none; border-radius: 14px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 12px; }
  .lock-error { color: #ffb3b3; font-size: 13px; min-height: 18px; text-align: center; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header { background: var(--green); padding: 20px 20px 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
  .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-leaf { font-size: 28px; }
  .logo-text { font-family: 'Playfair Display', serif; color: white; font-size: 20px; font-weight: 700; line-height: 1; }
  .logo-sub { color: var(--green-light); font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; }
  .header-right { display: flex; gap: 8px; align-items: center; }
  .add-btn { background: var(--gold); color: var(--brown); border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 26px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
  .lock-icon-btn { background: rgba(255,255,255,0.15); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
  .search-wrap { position: relative; }
  .search-input { width: 100%; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); border-radius: 10px; padding: 10px 16px 10px 40px; color: white; font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; }
  .search-input::placeholder { color: rgba(255,255,255,0.6); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; opacity: 0.7; }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tabs { display: flex; background: white; border-bottom: 2px solid var(--border); position: sticky; top: 108px; z-index: 99; }
  .tab { flex: 1; padding: 10px 2px; text-align: center; font-size: 10px; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; }
  .tab.active-all { color: var(--brown); border-color: var(--brown); }
  .tab.active-liked { color: var(--green); border-color: var(--green); }
  .tab.active-disliked { color: var(--red); border-color: var(--red); }

  /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
  .stats { display: flex; gap: 10px; padding: 14px 16px; background: white; border-bottom: 1px solid var(--border); }
  .stat { flex: 1; text-align: center; padding: 8px; border-radius: 10px; }
  .stat-all { background: #f5f0e8; } .stat-liked { background: var(--green-pale); } .stat-disliked { background: var(--red-pale); }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; line-height: 1; }
  .stat-all .stat-num { color: var(--brown); } .stat-liked .stat-num { color: var(--green); } .stat-disliked .stat-num { color: var(--red); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.8px; }

  /* ‚îÄ‚îÄ SYNC BANNER ‚îÄ‚îÄ */
  .sync-banner { display: flex; align-items: center; gap: 8px; padding: 8px 16px; font-size: 12px; color: var(--muted); background: white; border-bottom: 1px solid var(--border); }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green-light); flex-shrink: 0; }
  .sync-dot.syncing { background: var(--gold); animation: pulse 1s ease-in-out infinite; }
  .sync-dot.error { background: var(--red-light); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* ‚îÄ‚îÄ PRODUCT LIST ‚îÄ‚îÄ */
  .product-list { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-icon { font-size: 52px; margin-bottom: 12px; }
  .empty-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--brown); margin-bottom: 6px; }
  .empty-sub { font-size: 14px; line-height: 1.5; }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); display: flex; border-left: 5px solid transparent; position: relative; cursor: pointer; }
  .card.liked { border-left-color: var(--green-light); }
  .card.disliked { border-left-color: var(--red-light); }
  .card.neutral { border-left-color: var(--gold); }
  .card-img { width: 90px; min-height: 90px; background: #f0ebe3; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 32px; overflow: hidden; }
  .card-img img { width: 90px; height: 100%; object-fit: cover; min-height: 90px; }
  .card-body { padding: 12px 40px 12px 14px; flex: 1; min-width: 0; }
  .card-name { font-weight: 600; font-size: 15px; line-height: 1.3; margin-bottom: 2px; }
  .card-category { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .stars-display { display: flex; gap: 2px; margin-bottom: 5px; }
  .star { font-size: 15px; display: inline-block; position: relative; color: #ddd; }
  .star.filled { color: var(--gold); }
  .star.half { color: #ddd; }
  .star.half::before { content: '‚òÖ'; position: absolute; left: 0; top: 0; width: 50%; overflow: hidden; color: var(--gold); display: block; }
  .card-note { font-size: 12px; color: var(--muted); line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .card-addedby { font-size: 10px; color: var(--muted); margin-top: 4px; font-style: italic; }
  .card-actions { position: absolute; top: 10px; right: 10px; }
  .card-action-btn { background: var(--cream); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .section-header { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--brown); padding: 4px 0 8px; border-bottom: 1px solid var(--border); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 200; align-items: flex-end; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; width: 100%; max-width: 480px; border-radius: 24px 24px 0 0; padding: 20px 20px 40px; max-height: 92vh; overflow-y: auto; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--brown); margin-bottom: 16px; text-align: center; }

  /* ‚îÄ‚îÄ ENTRY METHODS ‚îÄ‚îÄ */
  .entry-methods { display: flex; gap: 8px; margin-bottom: 16px; }
  .entry-btn { flex: 1; padding: 10px 6px; border: 2px solid var(--border); border-radius: 12px; background: white; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; text-align: center; }
  .entry-btn.active { border-color: var(--green); color: var(--green); background: var(--green-pale); }
  .entry-icon { font-size: 20px; display: block; margin-bottom: 3px; }

  /* ‚îÄ‚îÄ PRODUCT SEARCH ‚îÄ‚îÄ */
  .product-search-wrap { position: relative; margin-bottom: 12px; }
  .product-search-input { width: 100%; padding: 12px 42px 12px 14px; border: 2px solid var(--green-light); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--text); outline: none; background: white; }
  .product-search-input::placeholder { color: var(--muted); }
  .product-search-spinner { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); display: none; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
  .product-search-spinner.show { display: block; }
  .search-results { border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 14px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
  .search-results.show { display: block; }
  .search-result-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border); background: white; }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:active { background: var(--green-pale); }
  .result-thumb { width: 46px; height: 46px; border-radius: 8px; background: #f0ebe3; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 22px; overflow: hidden; }
  .result-thumb img { width: 46px; height: 46px; object-fit: cover; border-radius: 8px; }
  .result-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .result-brand { font-size: 11px; color: var(--muted); margin-top: 1px; }
  .search-no-results { padding: 14px; text-align: center; font-size: 13px; color: var(--muted); background: white; }
  .search-tip { font-size: 12px; color: var(--muted); margin-bottom: 14px; text-align: center; line-height: 1.4; }

  /* ‚îÄ‚îÄ SELECTED PRODUCT ‚îÄ‚îÄ */
  .selected-product { display: none; background: var(--green-pale); border: 1.5px solid var(--green-light); border-radius: 12px; padding: 12px 14px; margin-bottom: 14px; flex-direction: row; align-items: center; gap: 12px; }
  .selected-product.show { display: flex; }
  .selected-thumb { width: 54px; height: 54px; border-radius: 10px; background: white; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 26px; overflow: hidden; }
  .selected-thumb img { width: 54px; height: 54px; object-fit: cover; border-radius: 10px; }
  .selected-info { flex: 1; min-width: 0; }
  .selected-name { font-weight: 600; font-size: 14px; color: var(--green); }
  .selected-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .selected-clear { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--muted); padding: 4px; flex-shrink: 0; }

  /* ‚îÄ‚îÄ SCANNER ‚îÄ‚îÄ */
  .scanner-wrap { display: none; position: relative; width: 100%; border-radius: 14px; overflow: hidden; background: black; margin-bottom: 14px; aspect-ratio: 4/3; }
  .scanner-wrap.active { display: block; }
  #barcode-scanner { width: 100%; height: 100%; }
  #barcode-scanner video { width: 100% !important; height: 100% !important; object-fit: cover; }
  #barcode-scanner canvas.drawingBuffer { display: none; }
  .scanner-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
  .scanner-frame { width: 72%; height: 46%; border: 3px solid var(--green-light); border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.45); position: relative; }
  .scanner-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--green-light); animation: scanLine 1.8s ease-in-out infinite; top: 0; }
  @keyframes scanLine { 0%,100% { top: 0; } 50% { top: calc(100% - 2px); } }
  .scanner-tip { color: rgba(255,255,255,0.85); font-size: 12px; margin-top: 14px; text-align: center; padding: 0 20px; }
  .scanner-status { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.65); color: white; padding: 5px 14px; border-radius: 20px; font-size: 12px; white-space: nowrap; }
  .stop-scan-btn { width: 100%; padding: 10px; background: #444; color: white; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 14px; cursor: pointer; margin-bottom: 12px; display: none; }

  /* ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ */
  .photo-upload { width: 100%; height: 110px; border: 2px dashed var(--border); border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 14px; background: var(--cream); position: relative; overflow: hidden; }
  .photo-upload img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
  .photo-upload-icon { font-size: 24px; margin-bottom: 4px; }
  .photo-upload-text { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
  .photo-upload input { display: none; }
  .photo-btns { display: flex; gap: 8px; z-index: 2; }
  .photo-choice-btn { padding: 7px 14px; background: white; border: 1.5px solid var(--border); border-radius: 20px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; color: var(--text); cursor: pointer; }
  .photo-choice-btn:active { background: var(--green-pale); border-color: var(--green-light); }
  .photo-choice-dark { background: rgba(0,0,0,0.55); color: white; border-color: rgba(255,255,255,0.3); }

  /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
  .field { margin-bottom: 12px; }
  .field label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); margin-bottom: 5px; }
  .field input, .field select, .field textarea { width: 100%; padding: 11px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--text); background: white; outline: none; transition: border-color 0.2s; }
  .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--green-light); }
  .field textarea { resize: vertical; min-height: 70px; }

  /* ‚îÄ‚îÄ STAR RATING ‚îÄ‚îÄ */
  .star-rating-input { display: flex; gap: 4px; justify-content: center; padding: 6px 0; }
  .star-input-wrap { position: relative; width: 40px; height: 40px; cursor: pointer; }
  .star-input-wrap .star-bg { font-size: 40px; color: #ddd; line-height: 1; }
  .star-input-wrap .star-fg { position: absolute; top: 0; left: 0; font-size: 40px; color: var(--gold); overflow: hidden; line-height: 1; width: 0%; transition: width 0.1s; }
  .star-input-wrap .half-zone { position: absolute; left: 0; top: 0; width: 50%; height: 100%; z-index: 2; }
  .star-input-wrap .full-zone { position: absolute; right: 0; top: 0; width: 50%; height: 100%; z-index: 2; }
  .rating-label { text-align: center; font-size: 13px; color: var(--muted); margin-top: 2px; min-height: 18px; }

  .save-btn { width: 100%; padding: 15px; background: var(--green); color: white; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }

  .who-btn { padding: 8px 16px; border-radius: 20px; border: 1.5px solid var(--border); background: white; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--muted); font-family: 'DM Sans', sans-serif; }
  .who-btn.active { border-color: var(--green); background: var(--green-pale); color: var(--green); }

  /* ‚îÄ‚îÄ CATEGORY FILTER ‚îÄ‚îÄ */
  .category-filter-wrap { background: white; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .category-filter-wrap::-webkit-scrollbar { display: none; }
  .category-filter { display: flex; gap: 8px; padding: 10px 16px; width: max-content; }
  .cat-btn { padding: 6px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: white; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; white-space: nowrap; }
  .cat-btn.active { background: var(--green); border-color: var(--green); color: white; }
  .cat-btn:active { opacity: 0.8; }

  /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
  .tab.active-history { color: #5b8dd9; border-color: #5b8dd9; }
  .history-card { background: white; border-radius: 14px; padding: 14px 16px; margin-bottom: 10px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 12px; cursor: pointer; border-left: 5px solid #5b8dd9; }
  .history-card:active { opacity: 0.85; }
  .history-thumb { width: 54px; height: 54px; border-radius: 10px; background: #f0ebe3; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; overflow: hidden; }
  .history-thumb img { width: 54px; height: 54px; object-fit: cover; border-radius: 10px; }
  .history-info { flex: 1; min-width: 0; }
  .history-name { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 2px; }
  .history-meta { font-size: 11px; color: var(--muted); }
  .history-add-btn { background: var(--green-pale); border: 1.5px solid var(--green-light); color: var(--green); border-radius: 20px; padding: 6px 12px; font-size: 12px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
  .history-empty { text-align: center; padding: 50px 20px; color: var(--muted); }
  .history-empty-icon { font-size: 40px; margin-bottom: 10px; }
  .history-clear-btn { display: block; margin: 16px auto 0; padding: 10px 24px; background: white; border: 1.5px solid var(--border); border-radius: 20px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; color: var(--muted); cursor: pointer; }
  .history-who { font-size: 10px; color: var(--muted); font-style: italic; margin-top: 2px; }
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="lockScreen">
  <div class="lock-leaf">üåø</div>
  <div class="lock-title">Farm Boy</div>
  <div class="lock-sub">Product Tracker</div>
  <div class="lock-label">Enter password to continue</div>
  <input class="lock-input" type="password" id="lockInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') tryUnlock()">
  <button class="lock-btn" onclick="tryUnlock()">Unlock</button>
  <div class="lock-error" id="lockError"></div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <header>
    <div class="header-top">
      <div class="logo">
        <span class="logo-leaf">üåø</span>
        <div>
          <div class="logo-text">Farm Boy</div>
          <div class="logo-sub">Product Tracker</div>
        </div>
      </div>
      <div class="header-right">
        <button class="lock-icon-btn" onclick="lockApp()">üîí</button>
        <button class="add-btn" onclick="openModal()">+</button>
      </div>
    </div>
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="search-input" type="text" placeholder="Search your products‚Ä¶" id="searchInput" oninput="renderProducts()">
    </div>
  </header>

  <div class="tabs">
    <div class="tab active-all" id="tab-all" onclick="setTab('all')">All</div>
    <div class="tab" id="tab-liked" onclick="setTab('liked')">üëç Liked</div>
    <div class="tab" id="tab-disliked" onclick="setTab('disliked')">üëé Disliked</div>
    <div class="tab" id="tab-history" onclick="setTab('history')">üïì History</div>
  </div>

  <div class="stats">
    <div class="stat stat-all"><div class="stat-num" id="stat-total">0</div><div class="stat-label">Total</div></div>
    <div class="stat stat-liked"><div class="stat-num" id="stat-liked">0</div><div class="stat-label">Liked</div></div>
    <div class="stat stat-disliked"><div class="stat-num" id="stat-disliked">0</div><div class="stat-label">Disliked</div></div>
  </div>

  <div class="sync-banner">
    <div class="sync-dot" id="syncDot"></div>
    <span id="syncLabel">Connecting to Firebase‚Ä¶</span>
  </div>

  <div class="category-filter-wrap" id="categoryFilterWrap">
    <div class="category-filter" id="categoryFilter">
      <button class="cat-btn active" onclick="setCategory('')">All</button>
    </div>
  </div>

  <div class="product-list" id="productList"></div>

  <div id="historyPanel" style="display:none; padding:16px;">
    <div class="recs-intro">
      <div class="recs-intro-icon">üïì</div>
      <div class="recs-intro-title">Scan History</div>
      <div class="recs-intro-sub">Barcodes you or Richard have scanned but not yet saved. Tap any item to add it to your list.</div>
    </div>
    <div id="historyContent"></div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalIfOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Add a Product</div>

    <div class="entry-methods">
      <button class="entry-btn active" id="btn-search" onclick="setEntryMethod('search')"><span class="entry-icon">üîç</span>Search</button>
      <button class="entry-btn" id="btn-scan" onclick="setEntryMethod('scan')"><span class="entry-icon">üì∑</span>Scan Barcode</button>
      <button class="entry-btn" id="btn-manual" onclick="setEntryMethod('manual')"><span class="entry-icon">‚å®Ô∏è</span>Manual</button>
    </div>

    <div id="searchPanel">
      <div class="search-tip">Search Farm Boy products ‚Äî type a product name and select from the results. If nothing comes up, use Manual entry.</div>
      <div class="product-search-wrap">
        <input class="product-search-input" type="text" id="productSearchInput" placeholder="e.g. Everything Bagel Dip‚Ä¶" oninput="onProductSearch(event)">
        <div class="product-search-spinner" id="searchSpinner"></div>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="selected-product" id="selectedProduct">
      <div class="selected-thumb" id="selectedThumb">üè∑Ô∏è</div>
      <div class="selected-info">
        <div class="selected-name" id="selectedName"></div>
        <div class="selected-sub" id="selectedSub"></div>
      </div>
      <button class="selected-clear" onclick="clearSelectedProduct()">‚úï</button>
    </div>

    <div class="scanner-wrap" id="scannerWrap">
      <div id="barcode-scanner"></div>
      <div class="scanner-overlay">
        <div class="scanner-frame"><div class="scanner-line"></div></div>
        <div class="scanner-tip">Hold steady ‚Äî point at the barcode on the product</div>
      </div>
      <div class="scanner-status" id="scannerStatus">Starting camera‚Ä¶</div>
    </div>
    <button class="stop-scan-btn" id="stopScanBtn" onclick="stopScanner()">‚úï Cancel Scan</button>

    <div class="photo-upload" id="photoUpload">
      <span class="photo-upload-icon">üì∏</span>
      <span class="photo-upload-text">Add a photo (optional)</span>
      <div class="photo-btns">
        <button class="photo-choice-btn" onclick="document.getElementById('photoFile').click()">üñºÔ∏è Choose Photo</button>
        <button class="photo-choice-btn" onclick="document.getElementById('cameraFile').click()">üì∑ Take Photo</button>
      </div>
      <input type="file" id="photoFile" accept="image/*" onchange="handlePhoto(event)" style="display:none">
      <input type="file" id="cameraFile" accept="image/*" capture="environment" onchange="handlePhoto(event)" style="display:none">
    </div>

    <div class="field">
      <label>Product Name *</label>
      <input type="text" id="inputName" placeholder="e.g. Aged Cheddar Crackers">
    </div>
    <div class="field">
      <label>Category</label>
      <select id="inputCategory">
        <option value="">‚Äî Select ‚Äî</option>
        <option>Snacks & Crackers</option>
        <option>Cheese & Dairy</option>
        <option>Bread & Bakery</option>
        <option>Beverages</option>
        <option>Sauces & Condiments</option>
        <option>Frozen Foods</option>
        <option>Deli & Charcuterie</option>
        <option>Pantry & Dry Goods</option>
        <option>Sweets & Desserts</option>
        <option>Fresh Produce</option>
        <option>Other</option>
      </select>
    </div>

    <div class="field">
      <label>Added by</label>
      <div style="display:flex;gap:10px;padding:4px 0;">
        <button class="who-btn active" id="who-me" onclick="setWho('me')">üë© Melanie</button>
        <button class="who-btn" id="who-partner" onclick="setWho('partner')">üë® Richard</button>
      </div>
    </div>

    <div class="field">
      <label>Your Rating</label>
      <div class="star-rating-input" id="starRatingInput">
        <div class="star-input-wrap" id="star-1"><span class="star-bg">‚òÖ</span><span class="star-fg" id="sfg-1">‚òÖ</span><span class="half-zone" onclick="setRating(0.5)"></span><span class="full-zone" onclick="setRating(1)"></span></div>
        <div class="star-input-wrap" id="star-2"><span class="star-bg">‚òÖ</span><span class="star-fg" id="sfg-2">‚òÖ</span><span class="half-zone" onclick="setRating(1.5)"></span><span class="full-zone" onclick="setRating(2)"></span></div>
        <div class="star-input-wrap" id="star-3"><span class="star-bg">‚òÖ</span><span class="star-fg" id="sfg-3">‚òÖ</span><span class="half-zone" onclick="setRating(2.5)"></span><span class="full-zone" onclick="setRating(3)"></span></div>
        <div class="star-input-wrap" id="star-4"><span class="star-bg">‚òÖ</span><span class="star-fg" id="sfg-4">‚òÖ</span><span class="half-zone" onclick="setRating(3.5)"></span><span class="full-zone" onclick="setRating(4)"></span></div>
        <div class="star-input-wrap" id="star-5"><span class="star-bg">‚òÖ</span><span class="star-fg" id="sfg-5">‚òÖ</span><span class="half-zone" onclick="setRating(4.5)"></span><span class="full-zone" onclick="setRating(5)"></span></div>
      </div>
      <div class="rating-label" id="ratingLabel">Tap a star to rate</div>
    </div>

    <div class="field">
      <label>Notes (optional)</label>
      <textarea id="inputNote" placeholder="What did you think? Would you buy it again?"></textarea>
    </div>

    <button class="save-btn" onclick="saveProduct()">Save Product</button>
  </div>
</div>

<!-- STANDALONE PASSWORD SCRIPT - runs independently of Firebase -->
<script>
  var PASSWORD = 'farmboy92';
  var SESSION_KEY = 'fb_unlocked';

  function tryUnlock() {
    var val = document.getElementById('lockInput').value;
    if (val === PASSWORD) {
      sessionStorage.setItem(SESSION_KEY, '1');
      document.getElementById('lockScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      document.getElementById('lockError').textContent = '';
    } else {
      document.getElementById('lockError').textContent = 'Incorrect password ‚Äî try again.';
      document.getElementById('lockInput').value = '';
      document.getElementById('lockInput').focus();
    }
  }

  function lockApp() {
    sessionStorage.removeItem(SESSION_KEY);
    document.getElementById('lockScreen').classList.remove('hidden');
    document.getElementById('app').style.display = 'none';
    document.getElementById('lockInput').value = '';
  }

  // Check session on load
  if (sessionStorage.getItem(SESSION_KEY) === '1') {
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('lockScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
    });
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() { document.getElementById('lockInput').focus(); }, 300);
    });
  }
</script>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmtxejkT-j2-fytzrrBXhyUrPx2CFH3uc",
    authDomain: "farmboy-tracker.firebaseapp.com",
    projectId: "farmboy-tracker",
    storageBucket: "farmboy-tracker.firebasestorage.app",
    messagingSenderId: "873331685664",
    appId: "1:873331685664:web:f89dc7f0dcb57867067f45"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const db = getFirestore(firebaseApp);

  // ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const PASSWORD = 'farmboy92';
  const SESSION_KEY = 'fb_unlocked';

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let products = [];
  let scanHistory = [];
  let currentCategory = '';
  let currentTab = 'all';
  let editingId = null;
  let currentRating = 0;
  let currentPhoto = null;
  let scannedBarcode = null;
  let scannerRunning = false;
  let searchTimer = null;
  let currentWho = 'me';
  let unsubscribe = null;
  let unsubHistory = null;

  const LABELS = {'0.5':'üò¨ Really Disliked','1':'üò¨ Really Disliked','1.5':'üòï Didn\'t Love It','2':'üòï Didn\'t Love It','2.5':'üòê It\'s OK','3':'üòê It\'s OK','3.5':'üòä Pretty Good','4':'üòä Pretty Good','4.5':'ü§© Loved It!','5':'ü§© Loved It!'};
  const WHO_LABELS = { me: 'üë© Melanie', partner: 'üë® Richard' };

  // ‚îÄ‚îÄ Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // tryUnlock and lockApp are defined in the standalone script above
  // Here we just hook into the unlock flow to start Firebase

  window.tryUnlock = function() {
    const val = document.getElementById('lockInput').value;
    if (val === PASSWORD) {
      sessionStorage.setItem(SESSION_KEY, '1');
      document.getElementById('lockScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      document.getElementById('lockError').textContent = '';
      startApp();
    } else {
      document.getElementById('lockError').textContent = 'Incorrect password ‚Äî try again.';
      document.getElementById('lockInput').value = '';
      document.getElementById('lockInput').focus();
    }
  }

  window.lockApp = function() {
    sessionStorage.removeItem(SESSION_KEY);
    if (unsubscribe) unsubscribe();
    document.getElementById('lockScreen').classList.remove('hidden');
    document.getElementById('app').style.display = 'none';
    document.getElementById('lockInput').value = '';
  }

  if (sessionStorage.getItem(SESSION_KEY) === '1') {
    document.getElementById('lockScreen').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    startApp();
  }

  // ‚îÄ‚îÄ Firebase real-time listener ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function startApp() {
    setSyncStatus('syncing', 'Connecting to Firebase‚Ä¶');
    try {
      unsubscribe = onSnapshot(collection(db, 'products'), (snapshot) => {
        products = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        products.sort((a, b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
        setSyncStatus('synced', 'Live sync active ‚úì');
        renderProducts();
      }, (error) => {
        setSyncStatus('error', 'Connection error ‚Äî check your internet');
      });

      unsubHistory = onSnapshot(collection(db, 'scanHistory'), (snapshot) => {
        scanHistory = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        scanHistory.sort((a, b) => (b.scannedAt?.seconds||0) - (a.scannedAt?.seconds||0));
        if (currentTab === 'history') renderHistory();
      });
    } catch(e) {
      setSyncStatus('error', 'Could not connect to Firebase');
    }
  }

  function setSyncStatus(state, label) {
    const dot = document.getElementById('syncDot');
    dot.className = 'sync-dot' + (state==='syncing' ? ' syncing' : state==='error' ? ' error' : '');
    document.getElementById('syncLabel').textContent = label;
  }

  // ‚îÄ‚îÄ Save to Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function persist(data, id = null) {
    setSyncStatus('syncing', 'Saving‚Ä¶');
    try {
      if (id) {
        await updateDoc(doc(db, 'products', id), { ...data, updatedAt: serverTimestamp() });
      } else {
        await addDoc(collection(db, 'products'), { ...data, createdAt: serverTimestamp() });
      }
      setSyncStatus('synced', 'Live sync active ‚úì');
    } catch(e) {
      setSyncStatus('error', 'Save failed ‚Äî check your internet');
      alert('Could not save product. Please check your connection and try again.');
    }
  }

  async function deleteProduct(id) {
    setSyncStatus('syncing', 'Deleting‚Ä¶');
    try {
      await deleteDoc(doc(db, 'products', id));
      setSyncStatus('synced', 'Live sync active ‚úì');
    } catch(e) {
      setSyncStatus('error', 'Delete failed');
    }
  }

  // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.setTab = function(t) {
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.className = 'tab');
    document.getElementById('tab-' + t).className = 'tab active-' + t;
    const isSpecial = t === 'history';
    document.getElementById('productList').style.display = isSpecial ? 'none' : 'flex';
    document.getElementById('historyPanel').style.display = t === 'history' ? 'block' : 'none';
    document.getElementById('categoryFilterWrap').style.display = isSpecial ? 'none' : 'block';
    if (!isSpecial) renderProducts();
    if (t === 'history') renderHistory();
  }

  window.setCategory = function(cat) {
    currentCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderProducts();
  }

  function buildCategoryFilter() {
    const cats = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
    const filter = document.getElementById('categoryFilter');
    filter.innerHTML = '<button class="cat-btn' + (currentCategory === '' ? ' active' : '') + '" onclick="setCategory(\'\')">All</button>' +
      cats.map(c => '<button class="cat-btn' + (currentCategory === c ? ' active' : '') + '" onclick="setCategory(\'' + c + '\')">' + c + '</button>').join('');
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderProducts() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    buildCategoryFilter();
    let list = products.filter(p => {
      const m = (p.name||'').toLowerCase().includes(q)||(p.category||'').toLowerCase().includes(q)||(p.note||'').toLowerCase().includes(q);
      if (!m) return false;
      if (currentCategory && p.category !== currentCategory) return false;
      if (currentTab==='liked') return p.rating>=3.5;
      if (currentTab==='disliked') return p.rating>0&&p.rating<=2;
      return true;
    });

    document.getElementById('stat-total').textContent = products.length;
    document.getElementById('stat-liked').textContent = products.filter(p=>p.rating>=3.5).length;
    document.getElementById('stat-disliked').textContent = products.filter(p=>p.rating>0&&p.rating<=2).length;

    const el = document.getElementById('productList');
    if (!list.length) {
      const msgs = {liked:['üåø','Nothing here yet','Rate something 4‚Äì5 ‚≠ê to see it here!'],disliked:['üçÇ','Nothing here yet','Rate something 1‚Äì2 ‚≠ê to see it here!'],all:['üõí','Nothing tracked yet','Tap + to add your first Farm Boy product!']};
      const [icon,title,sub] = msgs[currentTab]||msgs.all;
      el.innerHTML = `<div class="empty-state"><div class="empty-icon">${icon}</div><div class="empty-title">${title}</div><div class="empty-sub">${sub}</div></div>`;
      return;
    }

    if (currentTab==='all') {
      const liked=list.filter(p=>p.rating>=3.5), neutral=list.filter(p=>p.rating===3||!p.rating), disliked=list.filter(p=>p.rating>0&&p.rating<=2);
      let h='';
      if (liked.length) h+=`<div class="section-header">üåø Liked</div>`+liked.map(cardHTML).join('');
      if (neutral.length) h+=`<div class="section-header">‚öñÔ∏è Mixed / Unrated</div>`+neutral.map(cardHTML).join('');
      if (disliked.length) h+=`<div class="section-header">üçÇ Didn't Like</div>`+disliked.map(cardHTML).join('');
      el.innerHTML = h;
    } else {
      el.innerHTML = list.map(cardHTML).join('');
    }
  }

  function cardHTML(p) {
    const s = p.rating>=4?'liked':p.rating>0&&p.rating<=2?'disliked':'neutral';
    const stars = [1,2,3,4,5].map(i => {
      if (p.rating >= i) return '<span class="star filled">‚òÖ</span>';
      if (p.rating >= i - 0.5) return '<span class="star half">‚òÖ</span>';
      return '<span class="star empty">‚òÖ</span>';
    }).join('');
    const img = p.photo ? `<div class="card-img"><img src="${p.photo}" alt="${p.name}" onerror="this.parentElement.innerHTML='üè∑Ô∏è'"></div>` : `<div class="card-img">üè∑Ô∏è</div>`;
    const addedBy = p.who ? `<div class="card-addedby">Added by ${WHO_LABELS[p.who]||p.who}</div>` : '';
    return `<div class="card ${s}" onclick="openModal('${p.id}')">
      ${img}
      <div class="card-body">
        <div class="card-name">${p.name}</div>
        ${p.category?`<div class="card-category">${p.category}</div>`:''}
        <div class="stars-display">${stars}</div>
        ${p.note?`<div class="card-note">${p.note}</div>`:''}
        ${addedBy}
      </div>
      <div class="card-actions"><button class="card-action-btn" onclick="event.stopPropagation();del('${p.id}')">üóëÔ∏è</button></div>
    </div>`;
  }

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.openModal = function(id=null) {
    editingId=id; currentRating=0; currentPhoto=null; scannedBarcode=null; currentWho='me';
    clearSelectedProduct();
    document.getElementById('productSearchInput').value = '';
    document.getElementById('searchResults').classList.remove('show');
    document.getElementById('inputName').value = '';
    document.getElementById('inputCategory').value = '';
    document.getElementById('inputNote').value = '';
    resetPhoto(); setWho('me'); setEntryMethod('search');

    if (id) {
      const p = products.find(x=>x.id===id);
      if (p) {
        document.getElementById('inputName').value = p.name||'';
        document.getElementById('inputCategory').value = p.category||'';
        document.getElementById('inputNote').value = p.note||'';
        currentRating = p.rating||0;
        currentPhoto = p.photo||null;
        scannedBarcode = p.barcode||null;
        currentWho = p.who||'me';
        if (p.photo) showPhotoPreview(p.photo);
        if (p.name) showSelectedProduct(p.name, p.photo||null, p.category||'');
        setWho(currentWho);
      }
    }
    document.getElementById('modalTitle').textContent = id ? 'Edit Product' : 'Add a Product';
    updateStars();
    document.getElementById('modalOverlay').classList.add('open');
  }

  window.closeModal = function() { stopScanner(); document.getElementById('modalOverlay').classList.remove('open'); }
  window.closeModalIfOutside = function(e) { if(e.target===document.getElementById('modalOverlay')) closeModal(); }

  window.setWho = function(w) {
    currentWho = w;
    document.getElementById('who-me').classList.toggle('active', w==='me');
    document.getElementById('who-partner').classList.toggle('active', w==='partner');
  }

  window.setEntryMethod = function(m) {
    ['search','scan','manual'].forEach(x => document.getElementById('btn-'+x).classList.toggle('active', x===m));
    document.getElementById('searchPanel').style.display = m==='search' ? 'block' : 'none';
    document.getElementById('photoUpload').style.display = m==='scan' ? 'none' : 'block';
    if (m==='scan') startScanner(); else stopScanner();
  }

  // ‚îÄ‚îÄ Product Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.onProductSearch = function(e) {
    const q = e.target.value.trim();
    clearTimeout(searchTimer);
    if (q.length < 2) { document.getElementById('searchResults').classList.remove('show'); return; }
    searchTimer = setTimeout(() => searchOFF(q), 300);
  }

  async function searchOFF(query) {
    const spinner = document.getElementById('searchSpinner');
    const resultsEl = document.getElementById('searchResults');
    spinner.classList.add('show'); resultsEl.classList.remove('show');
    try {
      // Search specifically for Farm Boy brand products
      const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent('Farm Boy ' + query)}&tagtype_0=brands&tag_contains_0=contains&tag_0=farm+boy&action=process&json=1&page_size=8&fields=product_name,brands,image_front_thumb_url,code`;
      const res = await fetch(url);
      const data = await res.json();
      const products = (data.products || []).filter(p =>
        (p.brands || '').toLowerCase().includes('farm boy')
      );
      renderSearchResults(products);
    } catch(err) {
      resultsEl.innerHTML = '<div class="search-no-results">‚ö†Ô∏è Search unavailable ‚Äî please enter the name manually.</div>';
      resultsEl.classList.add('show');
    }
    spinner.classList.remove('show');
  }

  function renderSearchResults(items) {
    const el = document.getElementById('searchResults');
    const seen = new Set();
    const clean = items.filter(p => {
      const name = (p.product_name||'').trim();
      if (!name || seen.has(name.toLowerCase())) return false;
      seen.add(name.toLowerCase()); return true;
    });
    if (!clean.length) { el.innerHTML = '<div class="search-no-results">No Farm Boy products found ‚Äî try shorter keywords (e.g. "bagel" instead of "everything bagel dip"), or use Manual entry below.</div>'; el.classList.add('show'); return; }
    el.innerHTML = clean.map(p => {
      const name = (p.product_name||'').trim();
      const brand = p.brands||'';
      const img = p.image_front_thumb_url||'';
      const thumb = img ? `<div class="result-thumb"><img src="${img}" onerror="this.parentElement.innerHTML='üè∑Ô∏è'"></div>` : `<div class="result-thumb">üè∑Ô∏è</div>`;
      const d = JSON.stringify({name,brand,img,code:p.code||''}).replace(/"/g,'&quot;');
      return `<div class="search-result-item" onclick="selectProduct(${d})">${thumb}<div><div class="result-name">${name}</div>${brand?`<div class="result-brand">${brand}</div>`:''}</div></div>`;
    }).join('');
    el.classList.add('show');
  }

  window.selectProduct = function(p) {
    document.getElementById('searchResults').classList.remove('show');
    document.getElementById('productSearchInput').value = '';
    document.getElementById('inputName').value = p.name;
    if (p.img && !currentPhoto) { currentPhoto = p.img; showPhotoPreview(p.img); }
    showSelectedProduct(p.name, p.img||null, p.brand||'');
  }

  function showSelectedProduct(name, imgSrc, sub) {
    document.getElementById('selectedName').textContent = name;
    document.getElementById('selectedSub').textContent = sub || 'Tap ‚úï to search again';
    const thumb = document.getElementById('selectedThumb');
    if (imgSrc && (imgSrc.startsWith('http')||imgSrc.startsWith('data:'))) {
      thumb.innerHTML = `<img src="${imgSrc}" onerror="this.parentElement.innerHTML='üè∑Ô∏è'">`;
    } else { thumb.textContent = 'üè∑Ô∏è'; }
    document.getElementById('selectedProduct').classList.add('show');
    document.getElementById('searchPanel').style.display = 'none';
  }

  window.clearSelectedProduct = function() {
    document.getElementById('selectedProduct').classList.remove('show');
    document.getElementById('searchPanel').style.display = 'block';
    document.getElementById('inputName').value = '';
    currentPhoto = null; resetPhoto();
  }

  // ‚îÄ‚îÄ Barcode Scanner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function lookupBarcode(code) {
    document.getElementById('scannerStatus').textContent = 'üîç Looking up product‚Ä¶';
    try {
      const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json?fields=product_name,brands,image_front_url`);
      const data = await res.json();
      if (data.status===1 && data.product?.product_name) {
        const p = data.product;
        return { name: p.product_name.trim(), brand: p.brands||'', img: p.image_front_url||'', code };
      }
    } catch(e) {}
    return { name:'', brand:'', img:'', code };
  }

  function startScanner() {
    document.getElementById('scannerWrap').classList.add('active');
    document.getElementById('stopScanBtn').style.display = 'block';
    document.getElementById('photoUpload').style.display = 'none';
    document.getElementById('scannerStatus').textContent = 'Starting camera‚Ä¶';
    Quagga.init({
      inputStream: { name:'Live', type:'LiveStream', target: document.getElementById('barcode-scanner'), constraints: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} } },
      decoder: { readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader','code_39_reader'] },
      locate: true, numOfWorkers: 2, frequency: 10
    }, function(err) {
      if (err) { document.getElementById('scannerStatus').textContent = '‚ö†Ô∏è Camera access denied. Please allow camera and try again.'; return; }
      document.getElementById('scannerStatus').textContent = 'üì∑ Scanning‚Ä¶';
      Quagga.start(); scannerRunning = true;
      let last=null, count=0;
      Quagga.onDetected(async function(result) {
        const code = result.codeResult.code;
        if (!code) return;
        if (code===last) count++; else { last=code; count=1; }
        if (count>=3) {
          Quagga.offDetected(); scannedBarcode = code;
          const product = await lookupBarcode(code);
          stopScanner();

          // Log to shared scan history
          try {
            const historyEntry = {
              barcode: code,
              name: product.name || ('Barcode: ' + code),
              brand: product.brand || '',
              photo: product.img || null,
              scannedAt: serverTimestamp(),
              scannedBy: currentWho
            };
            await addDoc(collection(db, 'scanHistory'), historyEntry);
          } catch(e) { /* silent fail - history is non-critical */ }

          if (product.name) {
            document.getElementById('inputName').value = product.name;
            if (product.img) { currentPhoto = product.img; showPhotoPreview(product.img); }
            showSelectedProduct(product.name, product.img||null, product.brand ? product.brand + ' ¬∑ Barcode found ‚úì' : 'Barcode found ‚úì');
          } else {
            showSelectedProduct('Barcode: ' + code, null, 'Not in database ‚Äî please type the product name below');
            document.getElementById('inputName').focus();
          }
          setEntryMethod('search');
          document.getElementById('searchPanel').style.display = 'none';
        }
      });
    });
  }

  window.stopScanner = function() {
    if (scannerRunning) { try { Quagga.stop(); } catch(e) {} scannerRunning = false; }
    document.getElementById('scannerWrap').classList.remove('active');
    document.getElementById('stopScanBtn').style.display = 'none';
    document.getElementById('photoUpload').style.display = 'block';
  }

  // ‚îÄ‚îÄ Photo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.handlePhoto = function(e) {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      resizeImage(ev.target.result, 400, (resized) => {
        currentPhoto = resized;
        showPhotoPreview(resized);
      });
    };
    r.readAsDataURL(f);
  }

  function resizeImage(dataUrl, maxSize, callback) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > h) { if (w > maxSize) { h = h * maxSize / w; w = maxSize; } }
      else { if (h > maxSize) { w = w * maxSize / h; h = maxSize; } }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      callback(canvas.toDataURL('image/jpeg', 0.7));
    };
    img.src = dataUrl;
  }
  function showPhotoPreview(src) {
    document.getElementById('photoUpload').innerHTML = `
      <img src="${src}" onerror="this.style.display='none'" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;">
      <div class="photo-btns" style="position:absolute;bottom:8px;left:0;right:0;">
        <button class="photo-choice-btn photo-choice-dark" onclick="document.getElementById('photoFile').click()">üñºÔ∏è Change</button>
        <button class="photo-choice-btn photo-choice-dark" onclick="document.getElementById('cameraFile').click()">üì∑ Retake</button>
      </div>
      <input type="file" id="photoFile" accept="image/*" onchange="handlePhoto(event)" style="display:none">
      <input type="file" id="cameraFile" accept="image/*" capture="environment" onchange="handlePhoto(event)" style="display:none">`;
  }
  function resetPhoto() {
    document.getElementById('photoUpload').innerHTML = `
      <span class="photo-upload-icon">üì∏</span>
      <span class="photo-upload-text">Add a photo (optional)</span>
      <div class="photo-btns">
        <button class="photo-choice-btn" onclick="document.getElementById('photoFile').click()">üñºÔ∏è Choose Photo</button>
        <button class="photo-choice-btn" onclick="document.getElementById('cameraFile').click()">üì∑ Take Photo</button>
      </div>
      <input type="file" id="photoFile" accept="image/*" onchange="handlePhoto(event)" style="display:none">
      <input type="file" id="cameraFile" accept="image/*" capture="environment" onchange="handlePhoto(event)" style="display:none">`;
  }

  // ‚îÄ‚îÄ Stars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.setRating = function(r) { currentRating=r; updateStars(); }
  function updateStars() {
    for (let i = 1; i <= 5; i++) {
      const fg = document.getElementById('sfg-' + i);
      if (!fg) continue;
      if (currentRating >= i) {
        fg.style.width = '100%'; // full star
      } else if (currentRating >= i - 0.5) {
        fg.style.width = '50%'; // half star
      } else {
        fg.style.width = '0%'; // empty
      }
    }
    document.getElementById('ratingLabel').textContent = LABELS[String(currentRating)] || 'Tap a star to rate';
  }

  // ‚îÄ‚îÄ Save / Delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.saveProduct = async function() {
    const name = document.getElementById('inputName').value.trim();
    if (!name) { alert('Please enter a product name!'); return; }
    // If photo is an external URL, store the URL directly (no size issue)
    // If it's base64 (user uploaded), it's already been resized to 400px
    const photo = currentPhoto || null;

    const data = {
      name,
      category: document.getElementById('inputCategory').value,
      note: document.getElementById('inputNote').value.trim(),
      rating: currentRating,
      photo: photo,
      barcode: scannedBarcode || null,
      who: currentWho
    };
    await persist(data, editingId);
    closeModal();
  }

  window.del = async function(id) {
    if (!confirm('Remove this product from the shared list?')) return;
    await deleteProduct(id);
  }

  // ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const WHO_LABELS_SHORT = { me: 'Melanie', partner: 'Richard' };

  function renderHistory() {
    const el = document.getElementById('historyContent');
    if (!scanHistory.length) {
      el.innerHTML = '<div class="history-empty"><div class="history-empty-icon">üì∑</div><div>No scan history yet.<br><span style="font-size:13px">Scanned barcodes you have not saved will appear here.</span></div></div>';
      return;
    }

    // Filter out scans that have already been saved as products
    const savedBarcodes = new Set(products.map(p => p.barcode).filter(Boolean));
    const unsaved = scanHistory.filter(h => !savedBarcodes.has(h.barcode));
    const saved = scanHistory.filter(h => savedBarcodes.has(h.barcode));

    let html = '';

    if (unsaved.length) {
      html += '<div class="section-header">üìã Not yet saved</div>';
      html += unsaved.map(h => historyCardHTML(h, false)).join('');
    }

    if (saved.length) {
      html += '<div class="section-header" style="margin-top:16px">‚úÖ Already in your list</div>';
      html += saved.map(h => historyCardHTML(h, true)).join('');
    }

    if (!unsaved.length && !saved.length) {
      html = '<div class="history-empty"><div class="history-empty-icon">‚úÖ</div><div>All scanned items have been saved!</div></div>';
    }

    html += '<button class="history-clear-btn" onclick="clearHistory()">üóëÔ∏è Clear all history</button>';
    el.innerHTML = html;
  }

  function historyCardHTML(h, alreadySaved) {
    const name = h.name || ("Barcode: " + h.barcode);
    const who = h.scannedBy ? "Scanned by " + (WHO_LABELS_SHORT[h.scannedBy] || h.scannedBy) : "";
    const date = h.scannedAt?.seconds ? new Date(h.scannedAt.seconds * 1000).toLocaleDateString("en-CA", {month:"short", day:"numeric"}) : "";
    const meta = [who, date].filter(Boolean).join(" ¬∑ ");
    const thumbHtml = h.photo ? ("<div class=\"history-thumb\"><img src=\"" + h.photo + "\" style=\"width:54px;height:54px;object-fit:cover;border-radius:10px;\" onerror=\"this.style.display='none'\"></div>") : "<div class=\"history-thumb\">&#128247;</div>";
    const btnHtml = alreadySaved ? "<span style=\"font-size:12px;color:var(--green);font-weight:600;\">&#10003; Saved</span>" : "<button class=\"history-add-btn\" data-hid=\"" + h.id + "\" onclick=\"addFromHistory(this)\">+ Add</button>";
    return "<div class=\"history-card\">" + thumbHtml + "<div class=\"history-info\"><div class=\"history-name\">" + name + "</div>" + (h.brand ? "<div class=\"history-meta\">" + h.brand + "</div>" : "") + (meta ? "<div class=\"history-who\">" + meta + "</div>" : "") + "</div>" + btnHtml + "</div>";
  }

  window.addFromHistory = function(btn) {
    const historyId = btn.dataset.hid;
    const item = scanHistory.find(h => h.id === historyId);
    if (!item) return;
    scannedBarcode = item.barcode;
    currentPhoto = item.photo || null;
    openModal();
    setTimeout(() => {
      document.getElementById('inputName').value = item.name || '';
      if (item.photo) showPhotoPreview(item.photo);
      if (item.name) showSelectedProduct(item.name, item.photo || null, item.brand || '');
    }, 100);
  }

  window.clearHistory = async function() {
    if (!confirm('Clear all scan history? This cannot be undone.')) return;
    try {
      const promises = scanHistory.map(h => deleteDoc(doc(db, 'scanHistory', h.id)));
      await Promise.all(promises);
    } catch(e) {
      alert('Could not clear history. Please try again.');
    }
  }


</script>